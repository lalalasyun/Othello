<html lang="ja">

<head>
<meta charset="UTF-8" name="viewport" content="width=device-width">
<title>オセロゲーム</title>
<link href="/favicon.ico" rel="icon" />
<style type="text/css">
#main {
	margin: 0px;
	width: 300px;
	height: 500px;
	transform-origin: 0px 0px;
}
button {
    padding: 1px 5px;
}
</style>
</head>
<script type="text/javascript">
		//let ws = new WebSocket('ws://lalalasyun.com/websocket/othello');
		let ws = new WebSocket('wss://othellojp.herokuapp.com/othello');
		let turn;
		var gameturn = true;
		var game = false;
		var onlinemode = false;
		var id;
		
		function stoneClick(x,y) {
			if(game && gameturn){
				ws.send("coord," + x + "," + y);
			}
		}
		
		function start(){
			var result = document.getElementById('result');
			var black = document.getElementById("black");
			var white = document.getElementById("white");
			var rate = document.getElementById('AIrate');
			if(game){
				document.getElementById('start').innerHTML = "スタート";
				result.innerHTML = "";
				black.innerHTML = "";
				white.innerHTML = "";
				rate.hidden = true;
				game = false;
				return;
			}
			rate.hidden = true;
			document.getElementById('start').innerHTML = "リセット";
			document.getElementById('usermenu').innerHTML = "";
			onlinemode = false;
			initStone();
			ws.send("start");
		}
		
		function online(){
			if(game){return;}
			var result = document.getElementById('result');
			var start = document.getElementById('start');
			var black = document.getElementById("black");
			var white = document.getElementById("white");
			var rate = document.getElementById('AIrate');
			
			if(!start.disabled){
				result.innerHTML = "プレイヤーを待っています";
				start.disabled = true;
				onlinemode = true;
				ws.send("online");
				rate.hidden = true;
				black.innerHTML = "";
				white.innerHTML = "";
			}else{
				rate.hidden = false;
				result.innerHTML = "";
				start.disabled = false;
				onlinemode = false;
				ws.send("offline");
			}
		}
		
		function login(){
			if(game){ return;}
			document.getElementById("id").value = "";
			document.getElementById("pass").value = "";
			var form = document.getElementById('form');
			form.hidden = form.hidden ? false:true;
		}
		
		function loginbtn(){
			id = document.getElementById("id").value;
			var pass = document.getElementById("pass").value;
			var form = document.getElementById('form');
			ws.send("login," + id +","+ pass);
			form.hidden = true;
		}
		
		function registerbtn(){
			id = document.getElementById("id").value;
			var pass = document.getElementById("pass").value;
			var form = document.getElementById('form');
			ws.send("register," + id +","+ pass);
			form.hidden = true;
		}
		
		function record(){
			
		}
		
		ws.onmessage = function(receive) {
			var result = document.getElementById('result');
			var black = document.getElementById("black");
			var white = document.getElementById("white");
			var start = document.getElementById('start');
			var userlog = document.getElementById('usermenu');
			var ary = receive.data.split(',');
			var command = ary[0];
			
			switch (command) {
			case "stone":
				result.innerHTML = "";
				game = true;
				initStone();
				var stone = ary[1].split('');
				var cntblack = 0;
				var cntwhite = 0;
				var cntputblack = 0;
				var cntputwhite = 0;
				for(var i = 0;i < 8;i++){
					for(var n = 0;n < 8;n++){
						var index = (8*i) + n;
						var type = Number(stone[index]);
						putStone(i,n,type);
						
						switch (type){
						case 1:
							cntwhite++;
							break;
						case 2:
							cntblack++;
							break;
						case 3:
							cntputblack++;
							break;
						case 4:
							cntputwhite++;
							break;
						}
					}
				}
				var cntput = cntputblack + cntputwhite;
				gameturn = (cntputblack > cntputwhite ? "black": "white") == turn ? true : false;
				var turnmess = gameturn ? "あなた" : "相手";
				result.innerHTML = turnmess + "のターン";
				if(cntput == 0){
					gameturn = true;
					result.innerHTML = "パス";
				}
				black.innerHTML = "黒:" + cntblack;
				white.innerHTML = "白:" + cntwhite;
				break;
			case "turn":
				turn = ary[1];
				break;
			case "matching":
				if(onlinemode){
					start.disabled = false;
					game = true;
					result.innerHTML = "プレイヤーが見つかりました";
				}
				break;
			case "rate":
				var rate = document.getElementById('AIrate');
				rate.innerHTML = ary[1];
				break;
			case "login":
				if(ary[1] == "success"){
					userlog.innerHTML = "ログインしました";
				}else{
					userlog.innerHTML = "ログインに失敗しました";
				}
				break;
			case "register":
				if(ary[1] == "success"){
					userlog.innerHTML = "登録しました";
				}else{
					userlog.innerHTML = "登録に失敗しました";
				}
				break;
			case "end":
				var cntwhite = Number(white.innerHTML);
				var cntblack = Number(black.innerHTML);
				winresult(cntwhite,cntblack);
				document.getElementById('start').innerHTML = "スタート";
				break;
			}	
		}
		
		function winresult(white,black){
			var result = document.getElementById('result');
			var resmess = black > white ? "黒の勝ち": "白の勝ち";
			var resmess = black == white ? "引き分け": resmess;
			result.innerHTML = resmess;
			game = false;
		}
		
		var canvas;
	    var context;
	    var block = 300 / 8;
	    var size;
	    function sample() {
	        canvas = document.getElementById('othello');
	        changesize();
			
	        if (canvas.getContext) {
	            context = canvas.getContext('2d');
	            initStone();
	        }

	        canvas.addEventListener("click", e => {
	            const rect = e.target.getBoundingClientRect();

	            // ブラウザ上での座標を求める
	            const viewX = e.clientX - rect.left,
	                viewY = e.clientY - rect.top;

	            // 表示サイズとキャンバスの実サイズの比率を求める
	            const scaleWidth = canvas.clientWidth / canvas.width * size,
	                scaleHeight = canvas.clientHeight / canvas.height * size;

	            // ブラウザ上でのクリック座標をキャンバス上に変換
	            const canvasX = Math.floor(viewX / scaleWidth),
	                canvasY = Math.floor(viewY / scaleHeight);

	            var x = Math.floor(canvasX / block);
	            var y = Math.floor(canvasY / block);
	            
	            stoneClick(x,y);
	        });
	    }
	    
	    function changesize() {
	    	var main = document.getElementById('main');
			var wsize = screen.width;
			size =  wsize / 300 ;
			if(size < 2){
				main.style.transform = "scale(" + size + ")";
			}else{
				size = 2;
				main.style.transform = "scale(" + size + ")";
			}
		}
	    
	    function initStone(){
	    	context.beginPath();
	    	context.fillStyle = 'green';
            context.fillRect(0, 0, 300, 300);

            for (var i = 0; i < 9; i++) {
                var move = block * i;
                context.strokeStyle = 'black';
                context.lineWidth = 2;
                
                context.moveTo(move, 0);
                context.lineTo(move, 300);
                context.stroke();

                context.moveTo(0, move);
                context.lineTo(300, move);
                context.stroke();
            }
	    }

	    function putStone(x, y, type) {
	        context.beginPath();
	        if(turn == "black" && type == 4){
	        	return;
	        }else if(turn == "white" && type == 3){
	        	return;
	        }
	        var stonex = block * x;
	        var stoney = block * y;
	        context.arc(stonex + block / 2, stoney + block / 2, 15, 0 * Math.PI / 180, 360 * Math.PI / 180, false);
	        switch (type) {
	            case 0:
	            	return false;
	                break;
	            case 1:
	                context.fillStyle = 'white';
	                context.fill();
	                break;
	            case 2:
	                context.fillStyle = 'black';
	                
	                context.fill();
	                break;
	            case 3:
	            	context.strokeStyle = 'black';
	            	context.lineWidth = 2 ;
	            	context.stroke() ;
	            	break;
	            case 4:
	            	context.strokeStyle = 'white';
	            	context.lineWidth = 2;
	            	context.stroke();
	            	break;
	            default:
	            	return false;
	            	break;
	        }
	        
	    }

	    
	</script>

<body id="main" onload="sample()">
	<canvas id="othello" width="300px" height="300px"></canvas>
	<br>
	<button id="start" onclick="start()">スタート</button>
	<button onclick="online()">オンライン</button>
	<button onclick="login()">ログイン</button>
	<button onclick="record()">レコード</button>
	<br>
	<article id="form" hidden=true>
		<input type="text" id="id">
		<input type="password"id="pass">
		<button onclick="loginbtn()">ログイン</button>
		<button onclick="registerbtn()">登録</button>
	</article>
	<span id="black"></span>
	<span id="white"></span>
	<span id="result"></span>
	<br>
	<span id="AIrate"></span>
	<br>
	<span id="usermenu"></span>
</body>

</html>